<div class="container-fluid py-4 px-5 bg-page">

  <div class="mb-2">
    <h1 class="fw-bold mb-1">{{ 'DASHBOARD.TITLE' | translate }}</h1>
    <p class="text-muted mb-0">{{ 'DASHBOARD.SUBTITLE' | translate }}</p>
  </div>

  <!-- ===== KPIs ===== -->
  <div class="row g-3 mt-1">
    @for (s of statCards(); track s.label) {
      <div class="col-12 col-md-6 col-xl-3">
        <div class="card kpi-card rounded-4 border-0">
          <div class="card-body d-flex align-items-center gap-3 p-4">
            <div class="kpi-icon rounded-3 d-inline-flex align-items-center justify-content-center">
              <i class="bi fs-4" [ngClass]="s.icon"></i>
            </div>
            <div>
              <div class="fs-4 fw-bold lh-1">{{ s.value }}</div>
              <!-- Id√©alement: s.labelKey | translate si tu passes les donn√©es en cl√©s -->
              <div class="text-muted small">{{ s.label }}</div>
            </div>
            @if (s.delta) {
              <div class="ms-auto">
                <span class="badge rounded-pill"
                      [ngClass]="'bg-' + (s.pillColor || 'secondary') + '-subtle text-' + (s.pillColor || 'secondary')">
                  {{ s.delta }}
                </span>
              </div>
            }
          </div>
        </div>
      </div>
    }
  </div>

  <div class="row g-3 mt-1">
    <!-- ===== Colonne gauche ===== -->
    <div class="col-lg-8">
      <!-- Gestion des Babyfoots -->
      <div class="card card-elev rounded-4 border-0 mb-3">
        <div class="card-body p-4">
          <div class="d-flex align-items-center mb-3">
            <h2 class="h6 fw-bold mb-0">{{ 'DASHBOARD.TABLES_TITLE' | translate }}</h2>
            <button class="btn btn-primary btn-sm rounded-3 ms-auto" (click)="onAddTable()">
              <i class="bi bi-plus-lg me-1"></i> {{ 'DASHBOARD.TABLES_ADD' | translate }}
            </button>
          </div>

          <!-- Liste dynamique des babyfoots -->
          <div *ngIf="tables().length === 0" class="text-muted small">
            Aucun babyfoot disponible.
          </div>

          <div class="vstack gap-2" *ngIf="tables().length > 0">
            @for (t of tables(); track t.idBabyfoot) {
              <div class="table-row border rounded-4 bg-white p-3">
                <div class="d-flex align-items-start gap-3">
                  <div class="flex-grow-1">
                    <div class="d-flex align-items-center gap-2">
                      <div class="fw-semibold">{{ t.idBabyfoot }}</div>
                      <span class="badge rounded-pill small"
                            [ngClass]="statusBadgeClass(t.statutBabyfoot)">
                            {{ t.statutBabyfoot === 'free' ? 'Libre'
                        : t.statutBabyfoot === 'occupied' ? 'Occup√©'
                          : 'Maintenance' }}
                      </span>
                    </div>

                    <div class="row small text-muted mt-2 g-2">
                      <div class="col-md-4">
                        <span class="text-uppercase text-muted me-1">{{ 'DASHBOARD.TABLES_ZONE' | translate }}:</span>
                        <span>{{ t.place }}</span>
                      </div>
                    </div>
                  </div>

                  <!-- Boutons d'action -->
                  <div class="d-flex align-items-center gap-2 ms-auto">
                    <button class="btn btn-light border rounded-3"
                            [attr.title]="'DASHBOARD.TABLES_VIEW' | translate"
                            (click)="viewTable(t)">
                      <i class="bi bi-eye"></i>
                    </button>
                    <button class="btn btn-light border rounded-3"
                            [attr.title]="'DASHBOARD.TABLES_EDIT' | translate"
                            (click)="editTable(t)">
                      <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-light border rounded-3"
                            [attr.title]="'DASHBOARD.TABLES_DELETE' | translate"
                            (click)="removeTable(t)">
                      <i class="bi bi-trash text-danger"></i>
                    </button>
                  </div>
                </div>
              </div>
            }
          </div>
        </div>
      </div>

      <!-- Gestion des Utilisateurs -->
      <div class="card card-elev rounded-4 border-0">
        <div class="card-body p-4">
          <div class="d-flex align-items-center mb-3">
            <h2 class="h6 fw-bold mb-0">{{ 'DASHBOARD.USERS_TITLE' | translate }}</h2>
            <div class="ms-auto d-flex align-items-center gap-2">
              <div class="searchbox position-relative">
                <i class="bi bi-search position-absolute top-50 start-0 translate-middle-y ms-2 text-muted"></i>
                <input type="text" class="form-control ps-5 rounded-3"
                       [placeholder]="'DASHBOARD.USERS_SEARCH_PLACEHOLDER' | translate" />
              </div>
              <button class="btn btn-primary btn-sm rounded-3" (click)="inviteUser()">
                <i class="bi bi-person-plus me-1"></i> {{ 'DASHBOARD.USERS_INVITE' | translate }}
              </button>
            </div>
          </div>

          <!-- Chargement -->
          <div *ngIf="isLoading()">Chargement...</div>
          <div *ngIf="error()" class="text-danger small">{{ error() }}</div>

          <!-- Liste -->
          <div class="vstack gap-2" *ngIf="!isLoading() && !error()">
            @for (u of users(); track u.id) {
              <div class="user-row border rounded-4 bg-white p-3 d-flex align-items-center">
                <p class="d-none">{{ u.id }}</p>
                <img [src]="u.avatarUrl" [alt]="u.name" class="rounded-circle me-3" width="44" height="44">
                <div class="flex-grow-1">
                  <div class="fw-semibold">{{ u.name }}</div>
                  <div class="text-muted small">{{ u.email }}</div>
                </div>

                <!-- üóëÔ∏è Bouton supprimer -->
                <button class="btn btn-light border rounded-3 ms-3"
                        title="Supprimer cet utilisateur"
                        (click)="deleteUser(u)">
                  <i class="bi bi-trash text-danger"></i>
                </button>
              </div>
            }
          </div>
          <!-- Pagination -->
          <nav class="mt-3" *ngIf="totalPages() > 1">
            <ul class="pagination justify-content-center mb-0">
              <li class="page-item" [class.disabled]="page() === 0">
                <button class="page-link" (click)="prevPage()">‚Äπ</button>
              </li>

              <li class="page-item disabled">
                <span class="page-link">{{ page() + 1 }} / {{ totalPages() }}</span>
              </li>

              <li class="page-item" [class.disabled]="page() + 1 >= totalPages()">
                <button class="page-link" (click)="nextPage()">‚Ä∫</button>
              </li>
            </ul>
          </nav>
        </div>
      </div>


    </div>
    <!-- ===== Colonne droite ===== -->
    <div class="col-lg-4">
      <!-- Actions rapides -->
      <div class="card card-elev rounded-4 border-0 mb-3">
        <div class="card-body p-4">
          <h3 class="h6 fw-bold mb-3">{{ 'DASHBOARD.ACTIONS_TITLE' | translate }}</h3>
          <div class="vstack gap-2">
            @for (a of quickActions(); track a.label) {
              <!-- Id√©alement: a.key -> {{ ('DASHBOARD.ACTIONS_' + a.key) | translate }} -->
              <button class="btn btn-light border rounded-3 d-flex align-items-center justify-content-start gap-2 text-start"
                      (click)="a.action()">
                <i class="bi" [ngClass]="a.icon"></i>
                <span>{{ a.label }}</span>
              </button>
            }
          </div>
        </div>
      </div>

      <!-- Activit√© r√©cente -->
      <div class="card card-elev rounded-4 border-0 mb-3">
        <div class="card-body p-4">
          <h3 class="h6 fw-bold mb-3">{{ 'DASHBOARD.ACTIVITY_TITLE' | translate }}</h3>
          <div class="vstack gap-2">
            @for (ac of activities(); track ac.text) {
              <div class="border rounded-4 p-3 bg-white d-flex align-items-start gap-2">
                <span class="rounded-3 p-2 bg-light-subtle border"><i class="bi" [ngClass]="ac.icon"></i></span>
                <div class="flex-grow-1">
                  <div class="fw-semibold">{{ ac.text }}</div>
                  @if (ac.hint) {
                    <div class="text-muted small">{{ ac.hint }}</div>
                  }
                </div>
                <span class="small text-muted">{{ ac.time }}</span>
              </div>
            }
          </div>
        </div>
      </div>

      <!-- √âtat du syst√®me -->
      <div class="card card-elev rounded-4 border-0">
        <div class="card-body p-4">
          <h3 class="h6 fw-bold mb-3">{{ 'DASHBOARD.SYSTEM_TITLE' | translate }}</h3>

          <div class="vstack gap-2">
            @for (s of systemStatus(); track s.name) {
              <div class="border rounded-4 p-3 bg-white d-flex align-items-center justify-content-between">
                <div>{{ s.name }}</div>
                <div class="d-flex align-items-center gap-2">
                  <span class="dot"
                        [class.bg-success]="s.color === 'success'"
                        [class.bg-warning]="s.color === 'warning'"
                        [class.bg-danger]="s.color === 'danger'"></span>
                  <span class="small"
                        [ngClass]="{
                          'text-success': s.color === 'success',
                          'text-warning': s.color === 'warning',
                          'text-danger':  s.color === 'danger'
                        }">
                        {{ s.color === 'success'
                    ? ('DASHBOARD.SYSTEM_OPERATIONAL' | translate)
                    : (s.color === 'warning'
                      ? ('DASHBOARD.SYSTEM_PARTIAL' | translate)
                      : ('DASHBOARD.SYSTEM_INCIDENT' | translate)) }}
                  </span>
                </div>
              </div>
            }
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
